{"version":3,"sources":["../../../src/commons/fixtures.js"],"names":[],"mappings":"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","file":"fixtures.js","sourcesContent":["import { extend } from './utils';\n\nvar baseUrl = '/fixtures';\nvar resetUrl = '/_ah/yawp/datastore/delete_all';\nvar lazyPropertyKeys = ['id']; // needed till harmony proxies\nvar async = true;\n\nvar api = {};\n\nexport default function (request) {\n\n    // config\n\n    function config(callback) {\n        var c = {\n            async: function (value) {\n                async = value;\n            },\n            baseUrl: function (url) {\n                baseUrl = url;\n            },\n            resetUrl: function (url) {\n                resetUrl = url;\n            },\n            lazyPropertyKeys: function (array) {\n                lazyPropertyKeys = array;\n            },\n            bind: function (endpointKey, endpoint, parentId) {\n                api[endpointKey] = bind(fixture, endpointKey, endpoint, parentId);\n            }\n        };\n\n        callback(c);\n\n        api.lazy = computeLazyApi();\n    }\n\n    // lib\n\n    var lazy = {};\n    var lazyProperties = {};\n\n    var cache = {};\n    var queue = [];\n\n    function bind(fn, endpointKey, endpoint, parentId) {\n        var bindFn = function () {\n            var args = Array.prototype.slice.call(arguments, 0);\n            args.unshift(parentId);\n            args.unshift(endpoint);\n            args.unshift(endpointKey);\n            return fn.apply(this, args);\n        };\n        bindFn.endpoint = endpoint;\n        return bindFn;\n    }\n\n    function reset() {\n        return request(resetUrl, null, {\n            method: 'GET',\n            async: async\n        }).then(() => {\n            cache = {};\n            queue = [];\n        });\n    }\n\n    function parseFunctions(object) {\n        var i;\n        for (i in object) {\n            if (!object.hasOwnProperty(i)) {\n                continue;\n            }\n\n            var property = object[i];\n\n            if (property instanceof Function) {\n                object[i] = property();\n                continue;\n            }\n\n            if (property instanceof Object) {\n                parseFunctions(property);\n                continue;\n            }\n        }\n    }\n\n    function prepareDataJSON(data) {\n        var newData = {};\n        extend(newData, data);\n        parseFunctions(newData);\n        return JSON.stringify(newData);\n    }\n\n    function save(endpoint, parentId, data) {\n        if (!endpoint) {\n            console.error('not endpoint?!');\n        }\n\n        var url = baseUrl + (parentId ? data[parentId] : '') + endpoint;\n        var query = null;\n\n        var result = request(url, query, {\n            method: 'POST',\n            async: async,\n            json: true,\n            body: prepareDataJSON(data)\n        });\n\n        if (async) {\n            return result;\n        }\n\n        var retrievedObject = null;\n        result.done(function (retrievedData) {\n            retrievedObject = retrievedData;\n        }).fail(function (data) {\n            throw Error('error: ' + data);\n        });\n        return retrievedObject;\n    }\n\n    function hasLazy(endpoint, key) {\n        if (!lazy[endpoint]) {\n            return false;\n        }\n        if (!lazy[endpoint][key]) {\n            return false;\n        }\n        return true;\n    }\n\n    function saveFixtureToCache(endpointKey, endpoint, parentId, data, key) {\n        var result = save(endpoint, parentId, data);\n\n        if (async) {\n            result.then((object) => {\n                cache[endpointKey][key] = object;\n            });\n            return result;\n        }\n\n        cache[endpointKey][key] = result;\n        return result;\n    }\n\n    function loadFixtureFromCache(endpointKey, key) {\n        if (!cache[endpointKey]) {\n            cache[endpointKey] = {};\n            return null;\n        }\n        return cache[endpointKey][key];\n    }\n\n    function fixture(endpointKey, endpoint, parentId, key, data) {\n        let object = loadFixtureFromCache(endpointKey, key);\n        if (object) {\n            return object;\n        }\n\n        if (!data) {\n            if (hasLazy(endpoint, key)) {\n                data = lazy[endpoint][key];\n            } else {\n                return null;\n            }\n        }\n\n        // TODO: mark for save and cache is called\n        if (!async) {\n            return saveFixtureToCache(endpointKey, endpoint, parentId, data, key);\n        } else {\n            queue.push(function () {\n                return saveFixtureToCache(endpointKey, endpoint, parentId, data, key);\n            });\n        }\n    }\n\n    function map(objects) {\n        var result = {};\n\n        for (var i in objects) {\n            var object = objects[i];\n\n            var key = object.key;\n            var value = object.value;\n\n            if (key instanceof Function) {\n                key = key();\n            }\n\n            result[key] = value;\n        }\n        return result;\n    }\n\n    function computeLazyPropertiesApi(apiKey, fixtureKey) {\n        var i, lazyPropertiesApi = {};\n\n        function addLazyPropertyApi(propertyKey) {\n            return function () {\n                return api[apiKey](fixtureKey)[propertyKey];\n            };\n        }\n\n        for (i = 0; i < lazyPropertyKeys.length; i++) {\n            var propertyKey = lazyPropertyKeys[i];\n            lazyPropertiesApi[propertyKey] = addLazyPropertyApi(propertyKey);\n        }\n\n        return lazyPropertiesApi;\n    }\n\n    function lazyMap(objects) {\n        return function () {\n            return map(objects);\n        };\n    }\n\n    function computeLazyApi() {\n        var lazyApi = {};\n\n        function addLazyApi(apiKey, endpoint) {\n            return function (fixtureKey, data) {\n                if (!lazy[endpoint]) {\n                    lazy[endpoint] = {};\n                    lazyProperties[endpoint] = {};\n                } else if (lazy[endpoint][fixtureKey]) {\n                    // lazy fixture already configured, someone is refering a\n                    // lazy property.\n                    return lazyProperties[endpoint][fixtureKey];\n                }\n\n                lazy[endpoint][fixtureKey] = data;\n                lazyProperties[endpoint][fixtureKey] = computeLazyPropertiesApi(apiKey, fixtureKey);\n            };\n        }\n\n        for (var apiKey in api) {\n            var endpoint = api[apiKey].endpoint;\n            lazyApi[apiKey] = addLazyApi(apiKey, endpoint);\n        }\n\n        lazyApi.map = lazyMap;\n        return lazyApi;\n    }\n\n    function load(callback) {\n        if (!queue.length) {\n            callback(cache);\n            return;\n        }\n\n        var promise = queue[0]();\n        for (var i = 1, l = queue.length; i < l; i++) {\n            promise = promise.then(queue[i]);\n        }\n\n        promise.then(() => {\n            queue = [];\n            callback(cache);\n        });\n    }\n\n    api.lazy = computeLazyApi();\n    api.load = load;\n    api.reset = reset;\n    api.map = map;\n    api.config = config;\n\n    return api;\n}"]}