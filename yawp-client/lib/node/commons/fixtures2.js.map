{"version":3,"sources":["../../../src/commons/fixtures2.js"],"names":[],"mappings":"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","file":"fixtures2.js","sourcesContent":["import { extend } from './utils';\n\nconst DEFAULT_BASE_URL = '/fixtures';\nconst DEFAULT_RESET_URL = '/_ah/yawp/datastore/delete_all';\nconst DEFAULT_LAZY_PROPERTIES = ['id']; // needed till harmony proxies\n\nexport default (request) => {\n\n    class Fixtures {\n        constructor() {\n            this.baseUrl = DEFAULT_BASE_URL;\n            this.resetUrl = DEFAULT_RESET_URL;\n            this.lazyProperties = DEFAULT_LAZY_PROPERTIES;\n            this.promise = null;\n            this.fixtures = [];\n            this.lazy = {};\n        }\n\n        config(callback) {\n            callback(this);\n        }\n\n        reset() {\n            return request(this.resetUrl, {\n                method: 'GET'\n            }).then(() => {\n                this.clear();\n            });\n        }\n\n        clear(all) {\n            this.promise = null;\n            for (let {name, path} of this.fixtures) {\n                this.bindFixture(name, path);\n                all && this.bindLazy(name, path);\n            }\n        }\n\n        bind(name, path) {\n            this.fixtures.push({name, path});\n            this.bindFixture(name, path);\n            this.bindLazy(name, path);\n        }\n\n        bindFixture(name, path) {\n            this[name] = new EndpointFixture(this, name, path).api;\n        }\n\n        bindLazy(name, path) {\n            this.lazy[name] = new LazyFixture(this, name, path).api;\n        }\n\n        chain(promiseFn) {\n            if (!this.promise) {\n                this.promise = promiseFn();\n            } else {\n                this.promise = this.promise.then(promiseFn)\n            }\n            return this.promise;\n        }\n\n        load(callback) {\n            if (!this.promise) {\n                callback();\n                return;\n            }\n            this.promise.then(() => {\n                callback();\n            });\n        }\n\n        getLazyFor(name, key) {\n            var lazy = this.lazy[name].self;\n            return lazy.getData(key);\n        }\n\n    }\n\n    class EndpointFixture {\n        constructor(fx, name, path) {\n            this.fx = fx;\n            this.name = name;\n            this.path = path;\n            this.api = this.createApi();\n        }\n\n        createApi() {\n            return (key, data) => {\n                return this.fx.chain(this.load(key, data));\n            };\n        }\n\n        url() {\n            return this.fx.baseUrl + this.path;\n        }\n\n        load(key, data) {\n            this.createPropertyStubs(key);\n            return this.createLoadPromiseFn(key, data);\n        }\n\n        createLoadPromiseFn(key, data) {\n            if (!data) {\n                data = this.fx.getLazyFor(this.name, key);\n            }\n\n            return () => {\n                if (this.isLoaded(key)) {\n                    return this.api[key];\n                }\n\n                return request(this.url(), {\n                    method: 'POST',\n                    json: true,\n                    body: JSON.stringify(this.prepare(data))\n                }).then((response) => {\n                    this.api[key] = response;\n                    return response;\n                });\n            }\n        }\n\n        prepare(data) {\n            let object = {};\n            extend(object, data);\n\n            for (let key of Object.keys(object)) {\n                let value = object[key];\n                if (value instanceof Function) {\n                    object[key] = value();\n                }\n            }\n            return object;\n        }\n\n        createPropertyStubs(key) {\n            if (this.api[key]) {\n                return;\n            }\n            let self = this;\n            this.api[key] = this.fx.lazyProperties.reduce((map, name) => {\n                map[name] = () => {\n                    return self.api[key][name];\n                }\n                return map;\n            }, {});\n            this.api[key].__stub__ = true;\n        }\n\n        isLoaded(key) {\n            return this.api[key] && !this.api[key].__stub__;\n        }\n    }\n\n    class LazyFixture {\n        constructor(fx, name, path) {\n            this.fx = fx;\n            this.name = name;\n            this.path = path;\n            this.data = {};\n            this.api = this.createApi();\n        }\n\n        createApi() {\n            let api = (key, data) => {\n                this.data[key] = data;\n            };\n            api.self = this;\n            return api;\n        }\n\n        getData(key) {\n            return this.data[key];\n        }\n    }\n\n    return new Fixtures();\n}\n"]}